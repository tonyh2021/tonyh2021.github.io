---
layout: post
title: "RN çƒ­æ›´æ–°åŠ code-push çš„åº”ç”¨"
description: ""
category: articles
tags: [React Native]
comments: true
---

## å‰è¨€

è·ç¦»ä¸Šæ¬¡æ›´æ–°å·²ç»å¾ˆä¹…äº†ã€‚

ä¸­é—´åšäº†ä¸€äº› SwiftGG å°ç»„çš„ç¿»è¯‘å·¥ä½œï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹çœ‹[è¿™é‡Œ](http://swift.gg/archives/)ã€‚æŠ€æœ¯ä¸Šä¸»è¦æ˜¯ RN æ–¹å‘çš„ç ”ç©¶ï¼Œä»å„ç§çº¢è‰²è­¦å‘Šåˆ°åœ¨å…¬å¸é¡¹ç›®ä¸­ä½¿ç”¨ï¼Œå†åˆ°æ–¹æ¡ˆçš„åŸºæœ¬æˆå‹ï¼ŒåŸºæœ¬å·²ç»ç®—æ˜¯ä¸Šé“äº†ã€‚ä¸»è¦æ˜¯æ€æƒ³çš„ä¸€äº›è½¬å˜ï¼Œæ²¡æœ‰è®°å½•æŠ€æœ¯çš„ä¸œè¥¿ã€‚æœ€è¿‘è¦ä¸Šçƒ­æ›´æ–°æ–¹æ¡ˆï¼Œç ”ç©¶äº†ä¸€ä¸‹ï¼Œæ„Ÿè§‰é…ç½®çš„ä¸€äº›ä¸œè¥¿æ¯”è¾ƒå¤šï¼Œå°±è®°å½•ä¸‹å§ã€‚

çƒ­æ›´æ–°æ–¹æ¡ˆä¸»è¦æœ‰å¾®è½¯çš„ [CodePush](https://microsoft.github.io/code-push/) åŠ [pushy](http://update.reactnative.cn/home) ã€‚è€ƒè™‘åˆ°çµæ´»æ€§åŠå®‰å…¨æ€§ï¼Œæœ€åè¿˜æ˜¯å€¾å‘äºéƒ¨ç½²è‡ªå·±çš„çƒ­æ›´æ–°æœåŠ¡å™¨ã€‚äºæ˜¯æ‰¾åˆ°äº† [code-push-server](https://github.com/lisong/code-push-server)ã€‚

åªè®°å½•æ­¥éª¤å’Œå…³é”®çš„å‘ï¼Œä¸å†èµ˜è¿°åŸç†å’ŒåŸå› ï¼Œæœ‰äº›åœ°æ–¹ä¼šç»™å‡ºé“¾æ¥ã€‚

## ç¯å¢ƒæ­å»º

ç›®å‰æ¯”è¾ƒç¨³å®šçš„ RN ç‰ˆæœ¬æ˜¯ 0.44.3ï¼Œå¯¹åº”çš„ `react-native-code-push` ç‰ˆæœ¬ä¸º 2.xã€‚

```javascript
"react": "16.0.0-alpha.6",
"react-native": "0.44.3",
"react-native-code-push": "2.1.1-beta"
```

`Podfile` é…ç½®æ–‡ä»¶æ·»åŠ ï¼š

```ruby
pod 'CodePush', :path => '../node_modules/react-native-code-push'
```

`npm install` ä¹‹åï¼Œåœ¨ ios ç›®å½•ä¸‹æ‰§è¡Œ `pod install`ã€‚

iOS é¡¹ç›®ç¼–è¯‘å¦‚æœæœ‰é”™ï¼Œåˆ™éœ€è¦å°†å„ç§ç¼“å­˜æ¸…æ‰ã€‚è¿˜æœ‰å°±æ˜¯ 0.44.3 æœ‰ä¸ª bugï¼Œå¤§æ¦‚æ˜¯ `import <RCTAnimation/RCTValueAnimatedNode.h>` æ‰¾ä¸åˆ°ã€‚éœ€è¦åœ¨ package.json æ·»åŠ æ„å»ºè„šæœ¬ï¼š

```javascript
"postinstall": "sed -i '' 's/#import <RCTAnimation\\/RCTValueAnimatedNode.h>/#import \"RCTValueAnimatedNode.h\"/' ./node_modules/react-native/Libraries/NativeAnimation/RCTNativeAnimatedNodesManager.h",
```

iOS é¡¹ç›®ä¸­çš„ plist æ–‡ä»¶æ·»åŠ é”®ä¸º `CodePushServerURL` å’Œ `CodePushDeploymentKey` çš„é…ç½®ï¼Œåé¢ä¼šè®²åˆ°å€¼ã€‚

å‚è€ƒï¼š

[https://github.com/Microsoft/react-native-code-push](https://github.com/Microsoft/react-native-code-push/blob/master/docs/setup-ios.md)

[https://github.com/coderwin/CodePushCN](https://github.com/coderwin/CodePushCN#IOS%E9%85%8D%E7%BD%AE)

## code-push-server éƒ¨ç½²

æ­¥éª¤åœ¨è¿™ä¸ª[é“¾æ¥](https://github.com/lisong/code-push-server#install-from-npm-package)è¯´çš„æ¯”è¾ƒç»†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨å¯åŠ¨ä¹‹å‰ï¼Œè¦å®‰è£…å¹¶å¯åŠ¨ mysql æœåŠ¡ã€‚

é…ç½® `config/config.js` æ–‡ä»¶é™¤äº†æ–‡æ¡£ä¸­æåˆ°çš„ä¿®æ”¹ä¹‹å¤–ï¼Œè¿˜éœ€è¦çš„ï¼Œä¸»è¦æœ‰ï¼šdb çš„ host å’Œå¯†ç ï¼ŒstorageDir ä¿®æ”¹ä¸ºè‡ªå·±çš„ç›®å½•ï¼ŒdownloadUrlï¼ŒdataDirã€‚ç›´æ¥æœç´¢å…³é”®å­—æ”¹æ‰å°±å¯ä»¥ï¼Œå¦åˆ™ä¼šæŠ¥æ²¡æœ‰æƒé™åˆ›å»ºç›®å½•çš„é”™è¯¯ã€‚

å…¶ä»–å‚è€ƒï¼š
[react native codepushä¹‹æ­å»ºè‡ªå·±çš„æ›´æ–°æœåŠ¡å™¨](http://www.jianshu.com/p/eb7fdee307dc)

ä¸Šé¢æåˆ°çš„ `CodePushServerURL` ä¸ºéƒ¨ç½²æœåŠ¡å™¨çš„ urlï¼Œæœ¬æœºæµ‹è¯•å¯ä»¥ä½¿ç”¨ http://127.0.0.1:3000 ï¼Œå±€åŸŸç½‘æµ‹è¯•å¯ä»¥æ›¿æ¢ç›¸åº”çš„ ip åœ°å€ã€‚

`CodePushDeploymentKey` æœ‰æåˆ°ï¼Œå°±æ˜¯ deploymentKeyã€‚ä¸åŒçš„ deployment å¯¹åº”ä¸åŒçš„ keyã€‚

## ä»£ç ä¿®æ”¹

iOS é¡¹ç›®ä¸­åŠ è½½ bundle çš„ä»£ç ä¿®æ”¹ä¸ºï¼š

```objective-c
jsCodeLocation = [CodePush bundleURLForResource:@"main" withExtension:@"jsbundle" subdirectory:@"bundle"];
```

CodePush æä¾›äº†å¥½å‡ ä¸ªåŠ è½½èµ„æºçš„æ–¹æ³•ï¼ŒæŒ‰éœ€ä½¿ç”¨ã€‚

åœ¨ `AppDelegate` ä¸­å¯ä»¥å¼•å…¥ `#import <React/RCTLog.h>` ï¼Œç„¶åä½¿ç”¨ `RCTSetLogThreshold(RCTLogLevelInfo);` å¼€å¯æ—¥å¿—ã€‚

js è¿™è¾¹çš„å…³é”®ä»£ç ï¼š

```javascript
import CodePush from 'react-native-code-push';

componentDidMount() {
    CodePush.notifyAppReady();//ä¸ºé¿å…è­¦å‘Š
    this.syncImmediate();
}

/** Update is downloaded silently, and applied on restart (recommended) */
_sync() {
    CodePush.sync(
    {},
    this._codePushStatusDidChange.bind(this),
    this._codePushDownloadDidProgress.bind(this)
    );
}


/** Update pops a confirmation dialog, and then immediately reboots the app */
syncImmediate() {
    CodePush.sync({
        installMode: CodePush.InstallMode.IMMEDIATE, //å¯åŠ¨æ¨¡å¼ä¸‰ç§ï¼šON_NEXT_RESUMEã€ON_NEXT_RESTARTã€IMMEDIATE
        updateDialog: {
            appendReleaseDescription:true,//æ˜¯å¦æ˜¾ç¤ºæ›´æ–°descriptionï¼Œé»˜è®¤ä¸ºfalse
            descriptionPrefix:"æ›´æ–°å†…å®¹ï¼š",//æ›´æ–°è¯´æ˜çš„å‰ç¼€ã€‚ é»˜è®¤æ˜¯â€ Description:
            mandatoryContinueButtonLabel:"ç«‹å³æ›´æ–°",//å¼ºåˆ¶æ›´æ–°çš„æŒ‰é’®æ–‡å­—ï¼Œé»˜è®¤ä¸ºcontinue
            mandatoryUpdateMessage:"å‘ç°æ–°ç‰ˆæœ¬ï¼Œè¯·ç¡®è®¤æ›´æ–°",//- å¼ºåˆ¶æ›´æ–°æ—¶ï¼Œæ›´æ–°é€šçŸ¥. Defaults to â€œAn update is available that must be installed.â€.
            optionalIgnoreButtonLabel: 'ç¨å',//éå¼ºåˆ¶æ›´æ–°æ—¶ï¼Œå–æ¶ˆæŒ‰é’®æ–‡å­—,é»˜è®¤æ˜¯ignore
            optionalInstallButtonLabel: 'åå°æ›´æ–°',//éå¼ºåˆ¶æ›´æ–°æ—¶ï¼Œç¡®è®¤æ–‡å­—. Defaults to â€œInstallâ€
            optionalUpdateMessage: 'å‘ç°æ–°ç‰ˆæœ¬ï¼Œæ˜¯å¦æ›´æ–°ï¼Ÿ',//éå¼ºåˆ¶æ›´æ–°æ—¶ï¼Œæ›´æ–°é€šçŸ¥. Defaults to â€œAn update is available. Would you like to install it?â€.
            title: 'æ›´æ–°æç¤º'//è¦æ˜¾ç¤ºçš„æ›´æ–°é€šçŸ¥çš„æ ‡é¢˜. Defaults to â€œUpdate availableâ€.,
        }
    },
    this._codePushStatusDidChange.bind(this),
    this._codePushDownloadDidProgress.bind(this)
    );
}

_codePushDownloadDidProgress(progress) {
    console.log(progress);
}

_codePushStatusDidChange(syncStatus) {
    switch(syncStatus) {
        case CodePush.SyncStatus.CHECKING_FOR_UPDATE:
        console.log("Checking for update.");
        break;
        case CodePush.SyncStatus.DOWNLOADING_PACKAGE:
        console.log("Downloading package.");  
        break;
        case CodePush.SyncStatus.AWAITING_USER_ACTION:
        console.log("Awaiting user action."); 
        break;
        case CodePush.SyncStatus.INSTALLING_UPDATE:
        console.log("Installing update."); 
        break;
        case CodePush.SyncStatus.UP_TO_DATE:
        console.log("App up to date.");
        break;
        case CodePush.SyncStatus.UPDATE_IGNORED:
        console.log("Update cancelled by user.");
        break;
        case CodePush.SyncStatus.UPDATE_INSTALLED:
        console.log("Update installed and will be applied on restart.");
        break;
        case CodePush.SyncStatus.UNKNOWN_ERROR:
        console.log("An unknown error occurred.");
        break;
    }
}

let codePushOptions = { checkFrequency: CodePush.CheckFrequency.MANUAL };

APP = CodePush(codePushOptions)(App);

AppRegistry.registerComponent('APP', () => APP);

```

## çƒ­æ›´æ–°æ“ä½œ

ä¸»è¦æ˜¯ä½¿ç”¨ `[code-push-cli](https://github.com/Microsoft/code-push)`ï¼Œè¿›è¡Œä¸€äº›æ“ä½œï¼Œå®ç°æ‰“åŒ…å’Œå‘å¸ƒã€‚
å…³é”®å‘½ä»¤å‚è€ƒï¼š[CodePush å‘½ä»¤è¡Œ](https://github.com/Microsoft/code-push/blob/master/cli/README-cn.md#%E5%8F%91%E5%B8%83%E6%9B%B4%E6%96%B0-general)

æœ€ä¸»è¦çš„æ˜¯ä½¿ç”¨ `code-push release-react` å‘½ä»¤ï¼Œæ­¤å‘½ä»¤å®é™…æ˜¯ `react-native bundle` å’Œ `code-push release` çš„åˆä½“ã€‚

åœ¨è¿™é‡Œæ³¨æ„ï¼ŒæŸ¥çœ‹ `code-push release-react` çš„å‘½ä»¤å¸®åŠ©ï¼Œæœ‰è¿™æ ·çš„å‚æ•°è¯´æ˜ã€‚iOS é»˜è®¤çš„ bundle åå­—ä¸º `main.jsbundle`ï¼Œæˆ‘ä¹‹å‰é…ç½®æ‰“åŒ…å‡ºçš„åå­—ä¸º `index.ios.jsbundle`ï¼Œä½†æ˜¯æ›´æ–°æ—¶ä¼šæç¤ºæ‰¾ä¸åˆ° `main.jsbundle`ï¼Œæ‰€ä»¥å°±æ”¹æ‰äº†ã€‚

--plistFile å‚æ•°ç”¨æ¥æŒ‡å®š iOS çš„ plist é…ç½®æ–‡ä»¶ï¼Œå–å…¶ä¸­çš„ç‰ˆæœ¬æ¥ä½œä¸ºåŸºç¡€ç‰ˆæœ¬è¿›è¡Œæ›´æ–°ã€‚

```shell
$ code-push release-react
Usage: code-push release-react <appName> <platform> [options]

é€‰é¡¹ï¼š
  --bundleName, -b           Name of the generated JS bundle file. If unspecified, the standard bundle name will be used, depending on the specified platform: "main.jsbundle" (iOS), "index.android.bundle" (Android) or "index.windows.bundle" (Windows)  [å­—ç¬¦ä¸²] [é»˜è®¤å€¼: null]
  ...
  --plistFile, -p            Path to the plist file which specifies the binary version you want to target this release at (iOS only).  [é»˜è®¤å€¼: null]
```

å¦å¤–ï¼ŒCodePush æ–¹æ¡ˆä¸­ï¼Œæ˜¯å¦æœ‰çƒ­æ›´æ–°éƒ½æ˜¯åŸºäº `code-push release-react` ä¸­æ‰€æŒ‡å®šçš„ -v å‚æ•°æˆ– plist ä¸­çš„ç‰ˆæœ¬ï¼Œè€Œçƒ­æ›´æ–°çš„ç‰ˆæœ¬ï¼ˆå¯ä»¥ç†è§£ä¸º bundle æ›´æ–°åŒ…çš„ç‰ˆæœ¬ï¼‰åˆ™ç”¨ `Label` æ ‡è¯†ã€‚æ¯”å¦‚æ‰§è¡Œå‘½ä»¤ `code-push deployment history <appName> <deploymentName>`ï¼š

![01](https://lettleprince.github.io/images/20171020-code-push/01.png)

ä¿®æ”¹ä¸‹å¯¼èˆªæ çš„é¢œè‰²ï¼Œç„¶åæ‰§è¡Œ `code-push release-react ...` å‘½ä»¤ï¼Œé‡å¯åå¯ä»¥çœ‹åˆ°å¯¼èˆªæ é¢œè‰²è¢«ä¿®æ”¹ğŸ˜†ã€‚

## æ€»ç»“

è‡³æ­¤ï¼Œæœ¬åœ°çš„ CodePush éƒ¨ç½²å·²ç»æˆåŠŸï¼Œä¸‹å‘¨å›æ¥å°±éœ€è¦é¡¹ç›®é›†æˆå’ŒæœåŠ¡éƒ¨ç½²äº†ï¼Œé‡åˆ°å‘ä¼šå†è®°å½•ä¸‹æ¥ã€‚


